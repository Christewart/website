---
layout: pr
date: 2024-03-20
title: "Implement 64 bit arithmetic op codes in the Script interpreter"
pr: 29221
authors: [Christewart]
components: ["consensus"]
host: christewart
status: upcoming
commit:
---

Many future extensions of the bitcoin protocol - such as [OP_TLUV](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-September/019419.html) - want to create smart contracts based on the amount of satoshis in a bitcoin output.

Unfortunately, Satoshi values can be up to 51 bits in value, but we can only do math on 32 bit values in Script.

This means we cannot safely do math on Satoshi values in the interpreter without 64bit arithmetic!

This PR introduces 64bit arithmetic op codes and a new (to the interpreter) number encoding.

## How arithmetic works currently in Script

Bitcoin has an embedded programming language called Script. Script has op codes such as OP_ADD and OP_SUB
that allow you to pop 2 elements off of the stack, perform the arithmetic operation and push the
resulting value back onto the stack. For instance, if my Script is using the old op codes

OP_1 OP_2 OP_ADD OP_3 OP_EQUALVERIFY

This Script will

1. Push 1 onto the stack
2. Push 2 onto the stack
3. OP_ADD consumes the two top stack elements - 1 and 2 - and adds them pushing 3 onto the stack
4. Push 3 onto the stack
5. Compare the top two stack elements (3, 3) and see if they are equal

Simple enough, now lets create a Script with some larger number values that would not be possible without this PR.

In this example, we are going to assume we are doing math on 1,000 BTC. In satoshis, this number is 100,000,000,000.
Encoded as [CScriptNum](https://github.com/bitcoin/bitcoin/blob/1105aa46dd1008c556b8c435f1efcb9be09a1644/src/script/script.h#L225) the hex representation for 1,000 BTC is `0x00e8764817`

0x00e8764817 0x00e8764817 OP_ADD 0x00d0ed902e OP_EQUALVERIFY

1. Push 100,000,000,000 onto the stack
2. Push 100,000,000,000 onto the stack
3. OP_ADD consumes the two top stack elements and FAILS with an [overflow exception](https://github.com/bitcoin/bitcoin/blob/1105aa46dd1008c556b8c435f1efcb9be09a1644/src/script/script.h#L248)

This [version fails because OP_ADD can only consume 4 byte inputs](https://github.com/bitcoin/bitcoin/blob/1105aa46dd1008c556b8c435f1efcb9be09a1644/src/script/interpreter.cpp#L961).
Even worse, this does not give the Script programmer to handle the exception thrown by CScriptNum.

## How arithmetic works with #29221

<!-- TODO: Before meeting, add notes and questions
## Notes



## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?
-->


<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.

### Meeting 2

-->
{% endirc %}
